# OS â€”â€” è‡ªç ” 32 ä½ C++20 Modules å†…æ ¸

è¿™æ˜¯ä¸€ä¸ªä»é›¶å¼€å§‹ç¼–å†™çš„ 32 ä½ i386 æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚å®ƒä¸ä¾èµ–ç°æœ‰çš„ libc æˆ–æ ‡å‡†åº“ï¼Œè€Œæ˜¯å®Œå…¨åŸºäº C++26 (Modules) ç‰¹æ€§è‡ªç ”äº†ä¸€å¥—å†…æ ¸åŸºç¡€è®¾æ–½ï¼ŒåŒ…æ‹¬å¼•å¯¼åŠ è½½å™¨ã€å†…å­˜ç®¡ç†ã€çº¿ç¨‹è°ƒåº¦ã€æ–‡ä»¶ç³»ç»Ÿã€è®¾å¤‡é©±åŠ¨ã€Shell ä»¥åŠç”¨æˆ·æ€æ”¯æŒã€‚

æœ¬é¡¹ç›®çš„ä¸»è¦ç›®æ ‡æ˜¯æ¢ç´¢ C++ æ–°ç‰¹æ€§ï¼ˆå¦‚ Modulesã€Conceptsã€Coroutines ç­‰ï¼‰åœ¨åº•å±‚ç³»ç»Ÿå¼€å‘ä¸­çš„åº”ç”¨ï¼Œå¹¶å®ç°ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„å®å†…æ ¸ã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### 1. ç°ä»£åŒ– C++ å¼€å‘ä½“éªŒ
- **C++ Modules (C++20/26)**ï¼šå½»åº•æŠ›å¼ƒä¼ ç»Ÿçš„å¤´æ–‡ä»¶åŒ…å«æ–¹å¼ï¼Œå…¨é¢é‡‡ç”¨ `import/export` æ¨¡å—åŒ–å¼€å‘ï¼Œæå‡æ„å»ºé€Ÿåº¦ä¸ä»£ç éš”ç¦»æ€§ã€‚
- **Freestanding ç¯å¢ƒ**ï¼šå†…æ ¸è‡ªå¸¦ç²¾ç®€ç‰ˆ C++ æ ‡å‡†åº“å®ç°ï¼ˆ`std` æ¨¡å—ï¼‰ï¼ŒåŒ…å« `vector`, `string`, `array`, `format`, `algorithm` ç­‰å¸¸ç”¨ç»„ä»¶ï¼Œæ— éœ€å¤–éƒ¨è¿è¡Œæ—¶æ”¯æŒã€‚
- **Modern Syntax**ï¼šå¤§é‡ä½¿ç”¨ `auto`, `constexpr`, lambda è¡¨è¾¾å¼, Concepts çº¦æŸç­‰ç°ä»£è¯­æ³•ã€‚

### 2. å†…å­˜ç®¡ç† (Memory Management)
- **åˆ†é¡µæœºåˆ¶**ï¼šå¼€å¯ CR0.PGï¼Œå®ç°äºŒçº§é¡µè¡¨æ˜ å°„ï¼Œå†…æ ¸ç©ºé—´ï¼ˆ1GBï¼‰ä¸ç”¨æˆ·ç©ºé—´ï¼ˆ3GBï¼‰éš”ç¦»ã€‚
- **å†…å­˜æ±  (Pool)**ï¼š
  - **ç‰©ç†å†…å­˜æ± **ï¼šç®¡ç†ç‰©ç†é¡µæ¡†çš„åˆ†é…ä¸å›æ”¶ã€‚
  - **è™šæ‹Ÿå†…å­˜æ± **ï¼šç®¡ç†å†…æ ¸ä¸ç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚
- **å †åˆ†é…å™¨**ï¼š
  - å†…æ ¸çº§ `malloc/free` å®ç°ã€‚
  - åŸºäº `arena` çš„ç»†ç²’åº¦å†…å­˜å—ç®¡ç†ï¼Œå‡å°‘ç¢ç‰‡ã€‚

### 3. è¿›ç¨‹ä¸çº¿ç¨‹ (Process & Thread)
- **å¤šçº¿ç¨‹æ¶æ„**ï¼šå†…æ ¸æ”¯æŒå†…æ ¸çº¿ç¨‹ï¼ˆKernel Threadï¼‰ä¸ç”¨æˆ·è¿›ç¨‹ï¼ˆUser Processï¼‰ã€‚
- **è°ƒåº¦å™¨**ï¼šåŸºäºä¼˜å…ˆçº§çš„è½®è½¬è°ƒåº¦ç®—æ³•ï¼Œç»´æŠ¤å°±ç»ªé˜Ÿåˆ—ï¼ˆReady Listï¼‰ä¸æ‰€æœ‰çº¿ç¨‹é˜Ÿåˆ—ã€‚
- **åŒæ­¥åŸè¯­**ï¼š
  - **ä¿¡å·é‡ (Semaphore)**
  - **äº’æ–¥é” (Mutex)**
  - **è‡ªæ—‹é”**ï¼ˆåº•å±‚åŸå­æ“ä½œï¼‰
- **è¿›ç¨‹ç®¡ç†**ï¼šæ”¯æŒ `fork`, `exec` (ELF32 åŠ è½½), `exit`, `wait` ç­‰ç»å…¸è¿›ç¨‹æ§åˆ¶åŸè¯­ã€‚

### 4. æ–‡ä»¶ç³»ç»Ÿ (File System)
- **è‡ªç ”æ–‡ä»¶ç³»ç»Ÿ**ï¼š
  - ç£ç›˜å¸ƒå±€ï¼šMBR -> Loader -> Kernel -> FileSystemã€‚
  - ç´¢å¼•ç»“ç‚¹ (Inode) ä¸è¶…çº§å— (SuperBlock) æœºåˆ¶ï¼ˆMagic: `0x19590318`ï¼‰ã€‚
  - æ”¯æŒç›®å½•ã€æ™®é€šæ–‡ä»¶ã€è®¾å¤‡æ–‡ä»¶ç­‰ç±»å‹ã€‚
- **VFS æ¥å£**ï¼šæä¾›æ ‡å‡† POSIX é£æ ¼æ¥å£ï¼š`open`, `close`, `read`, `write`, `lseek`, `stat`, `unlink`, `mkdir`, `opendir` ç­‰ã€‚

### 5. ç”¨æˆ·æ€ä¸ Shell
- **ç³»ç»Ÿè°ƒç”¨ (System Calls)**ï¼šé€šè¿‡ `int 0x80` ä¸­æ–­å®ç°ï¼Œç›®å‰æ”¯æŒ `getpid`, `write`, `read`, `fork`, `exec`, `malloc` ç­‰ 30+ ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚
- **äº¤äº’å¼ Shell**ï¼š
  - å†…ç½® Shell æ”¯æŒå¸¸ç”¨å‘½ä»¤ï¼š`ls`, `cd`, `pwd`, `ps`, `clear`, `mkdir`, `rm`, `rmdir`ã€‚
  - æ”¯æŒå‰å°è¿è¡Œç”¨æˆ·ç¨‹åºï¼ˆé€šè¿‡ ELF è§£æåŠ è½½æ‰§è¡Œï¼‰ã€‚
  - æ”¯æŒæ ‡å‡†è¾“å…¥è¾“å‡ºæµé‡å®šå‘ä¸è¡Œç¼–è¾‘ï¼ˆBackspace, Ctrl+u, Ctrl+lï¼‰ã€‚
- **ELF è§£æ**ï¼šå†…ç½® ELF32 è§£æå™¨ï¼Œå¯ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½å¹¶æ‰§è¡Œæ ‡å‡† ELF å¯æ‰§è¡Œæ–‡ä»¶ã€‚

### 6. è®¾å¤‡é©±åŠ¨
- **IDE ç¡¬ç›˜**ï¼šæ”¯æŒ PIO æ¨¡å¼è¯»å†™ï¼Œè‡ªåŠ¨è¯†åˆ«åˆ†åŒºè¡¨ï¼ˆMBR/EBRï¼‰ã€‚
- **é”®ç›˜**ï¼š8042 æ§åˆ¶å™¨é©±åŠ¨ï¼Œæ”¯æŒæ‰«æç è§£æä¸ä¿®é¥°é”®çŠ¶æ€æœºã€‚
- **PIT å®šæ—¶å™¨**ï¼šæä¾›ç³»ç»Ÿæ—¶é’ŸèŠ‚æ‹ä¸æ—¶é—´ç‰‡è½®è½¬æ”¯æŒã€‚
- **VGA æ§åˆ¶å°**ï¼šæ”¯æŒå­—ç¬¦è¾“å‡ºã€å…‰æ ‡æ§åˆ¶ã€æ»šå±ã€‚

---

## ğŸ› ï¸ æ„å»ºä¸å¼€å‘ç¯å¢ƒ

### ä¾èµ–å·¥å…·
- **Linux (x86_64)**
- **CMake** (å»ºè®® >= 3.20)
- **Ninja** (æ„å»ºé€Ÿåº¦æ›´å¿«)
- **GCC/G++** (éœ€æ”¯æŒ C++20 Modules ä¸ `-m32` äº¤å‰ç¼–è¯‘)
- **NASM** (æ±‡ç¼–å™¨)
- **Bochs** (ä»¿çœŸä¸è°ƒè¯•)
- **GDB** (è¿œç¨‹è°ƒè¯•)

### å®‰è£…ä¾èµ– (Debian/Ubuntu)
```bash
sudo apt update
sudo apt install -y cmake ninja-build nasm gdb bochs bochs-sdl
sudo apt install -y gcc g++ gcc-multilib g++-multilib
```

### æ„å»ºæ­¥éª¤
1. **é…ç½®å·¥ç¨‹**
   ```bash
   cmake -S . -B cmake-build-debug -G Ninja -DCMAKE_BUILD_TYPE=Debug
   ```

2. **ç¼–è¯‘å†…æ ¸ä¸å·¥å…·**
   ```bash
   cmake --build cmake-build-debug
   ```

3. **åˆ¶ä½œç£ç›˜é•œåƒ (é¦–æ¬¡è¿è¡Œéœ€æ‰§è¡Œ)**
   ```bash
   # åˆ›å»º 64MB ä¸»ç›˜ (ç³»ç»Ÿç›˜)
   dd if=/dev/zero of=hd64M.img bs=1M count=64
   # åˆ›å»º 80MB ä»ç›˜ (æ•°æ®ç›˜ï¼Œç”¨äºæ–‡ä»¶ç³»ç»Ÿ)
   dd if=/dev/zero of=hd80M.img bs=1M count=80
   ```

4. **å†™å…¥å¼•å¯¼ä¸å†…æ ¸ (OS Build)**
   ```bash
   # å°† MBR, Loader, Kernel å†™å…¥ hd64M.img
   cmake --build cmake-build-debug --target osbuild
   ```

---

## â–¶ï¸ è¿è¡Œä¸è°ƒè¯•

### å¯åŠ¨ Bochs
```bash
# æ™®é€šè¿è¡Œ
bochs -qf bochsrc.disk

# è°ƒè¯•æ¨¡å¼ (å¼€å¯ gdbstub ç«¯å£ 1234)
bochs -qf bochsrc-gdb.disk
```

### GDB è¿æ¥è°ƒè¯•
åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­æ‰§è¡Œï¼š
```bash
gdb cmake-build-debug/bin/kernel \
  -ex 'set disassemble-next-line on' \
  -ex 'target remote :1234' \
  -ex 'continue'
```

### ç³»ç»Ÿä½“éªŒ
å¯åŠ¨åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆå§‹åŒ–å„å­ç³»ç»Ÿï¼Œé»˜è®¤ä¼šè¿›å…¥ `kernel/main.cpp` ä¸­å®šä¹‰çš„é€»è¾‘ã€‚
è‹¥è¿›å…¥ Shell æ¨¡å¼ï¼Œä½ å¯ä»¥å°è¯•ä»¥ä¸‹å‘½ä»¤ï¼š
```text
k@kkkzbh /> ls -l
k@kkkzbh /> mkdir code
k@kkkzbh /> cd code
k@kkkzbh /code> pwd
/code
k@kkkzbh /code> ps
```

---

## ğŸ“‚ ç›®å½•ç»“æ„è¯´æ˜

```
.
â”œâ”€â”€ boot/               # å¼•å¯¼åŠ è½½å™¨ (MBR, Loader) æ±‡ç¼–ä»£ç 
â”œâ”€â”€ kernel/             # å†…æ ¸ä¸»æºç 
â”‚   â”œâ”€â”€ src/            # åŸºç¡€ C/Asm æ”¯æŒåº“ (stdio, string)
â”‚   â”œâ”€â”€ module/         # C++ æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ memory/     # å†…å­˜ç®¡ç† (Alloc, Paging, Pool)
â”‚   â”‚   â”œâ”€â”€ thread/     # çº¿ç¨‹ä¸è¿›ç¨‹ (Scheduler, Sync, Process)
â”‚   â”‚   â”œâ”€â”€ filesystem/ # æ–‡ä»¶ç³»ç»Ÿå®ç°
â”‚   â”‚   â”œâ”€â”€ shell/      # å†…ç½® Shell å®ç°
â”‚   â”‚   â”œâ”€â”€ user/       # ç”¨æˆ·æ€æ”¯æŒ (Syscall, ELF Loader)
â”‚   â”‚   â””â”€â”€ std/        # è‡ªç ” C++ æ ‡å‡†åº“ (vector, array, etc.)
â”‚   â””â”€â”€ test/           # å†…æ ¸æµ‹è¯•ç”¨ä¾‹
â”œâ”€â”€ device/             # è®¾å¤‡é©±åŠ¨ (IDE, Keyboard, Time, Console)
â”œâ”€â”€ bochsrc.disk        # Bochs é…ç½®æ–‡ä»¶
â””â”€â”€ CMakeLists.txt      # é¡¶å±‚æ„å»ºè„šæœ¬
```

---

## ğŸ“ è´¡çŒ®ä¸ License
æœ¬é¡¹ç›®ä¸ºä¸ªäººè‡ªç ”æ“ä½œç³»ç»Ÿå­¦ä¹ é¡¹ç›®ï¼Œä»£ç é£æ ¼æ¿€è¿›ï¼ˆæ‹¥æŠ± C++ æœ€æ–°ç‰¹æ€§ï¼‰ã€‚æ¬¢è¿æäº¤ Issue æˆ– Pull Request è¿›è¡Œäº¤æµã€‚

License: MIT (æˆ–æ ¹æ®å®é™…æƒ…å†µæ·»åŠ )
