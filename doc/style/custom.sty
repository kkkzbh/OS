% Custom style for OS textbook-like docs (ctex + code highlighting)
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{custom}[2025/11/06 OS Docs custom style]

% Core packages
\RequirePackage{xcolor}
\RequirePackage{fontspec}
\RequirePackage{microtype}
\RequirePackage{geometry}
\RequirePackage{graphicx}
\RequirePackage{xstring}
\RequirePackage{fancyhdr}
\RequirePackage{hyperref}
\RequirePackage{bookmark}
\RequirePackage{caption} % for \captionof to make non-floating tables
\RequirePackage{cleveref}
\RequirePackage{etoolbox}
\RequirePackage{ifthen}
\RequirePackage{longtable}
\RequirePackage{booktabs}
\RequirePackage{tabularx}
% Precise float placement (e.g., tables with [H])
\RequirePackage{float}
% Ensure minted sees outputdir before any dependent package may load it
\PassOptionsToPackage{outputdir=_build}{minted}
\RequirePackage{minted}
% Load tcolorbox without auto-loading minted; enable minted library after
\RequirePackage[skins,breakable,listings]{tcolorbox}
\tcbuselibrary{minted}
\RequirePackage{tikz}

% Layout
\geometry{margin=28mm}
\setlength{\parskip}{0pt}
\setlength{\parindent}{2em}
\linespread{1.25}
% Be more forgiving to avoid overfull boxes in mixed CJK+code text
\emergencystretch=2em
\tolerance=1600

% Colors (low-saturation for textbook style)
\definecolor{Gray}{HTML}{6B7280}
\definecolor{CodeBg}{HTML}{FFFFFF}
\definecolor{CodeFrame}{gray}{0.85}
\definecolor{NoteBg}{HTML}{FFFFFF}
\definecolor{WarnBg}{HTML}{FFFFFF}
\definecolor{WarnFrame}{gray}{0.85}
% Quick-start (purple) palette
\definecolor{QSBack}{HTML}{F5F3FF}   % very light purple background
\definecolor{QSFrame}{HTML}{DDD6FE}  % light purple frame
\definecolor{QSAccent}{HTML}{7C3AED} % strong purple accent for left border/title
% Code accents (light blue)
\definecolor{CodeAccent}{HTML}{93C5FD} % blue-300
\definecolor{CodeTitleBack}{HTML}{DBEAFE} % blue-200 for title bar
% Code line number color
\definecolor{CodeLineNumber}{HTML}{64748B} % slate-500
% Thin separator line only (no filled gutter)
\definecolor{GutterLine}{HTML}{93C5FD} % match CodeAccent

% Fonts (no fallback: missing fonts will error)
% Required fonts:
%  - Latin serif: Libertinus Serif
%  - Latin sans:  Inter
%  - Monospace:   JetBrains Mono
%  - CJK serif:   Source Han Serif SC (思源宋体)
%  - CJK sans:    Source Han Sans SC  (思源黑体)
\defaultfontfeatures{Ligatures=TeX}
\makeatletter
\@ifpackageloaded{ctexhook}{}{\RequirePackage{ctex}} % ensure ctex base loaded
\makeatother
\setmainfont{Libertinus Serif}
\setsansfont{Inter}
\setmonofont{JetBrains Mono}
% Switch to Noto CJK (Plan B)
\setCJKmainfont{Noto Serif CJK SC}
\setCJKsansfont{Noto Sans CJK SC}

% Headings (compact, textbook-like)
\ctexset{
  chapter = {
    format = \bfseries\zihao{3},
    name = {第,章},
    number = {\chinese{chapter}},
    beforeskip = 12pt,
    afterskip  = 6pt,
  },
  section = {
    format = \bfseries\zihao{4},
    beforeskip = 8pt,
    afterskip  = 4pt,
  },
  subsection = {
    format = \bfseries\zihao{5},
    beforeskip = 6pt,
    afterskip  = 3pt,
  }
}

% Header & footer
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE,RO]{\nouppercase{\leftmark}}
\fancyfoot[CE,CO]{\thepage}

% Hyperlinks
\hypersetup{colorlinks=true,linkcolor=black,urlcolor=black,citecolor=black}

% Code highlighting: force minted (no fallback)
% (Options already passed and package loaded above.)
% JetBrains-like light theme via custom pygments style (minted)
% Allow breaking long tokens if needed to avoid overflow
\setminted{breaklines,breakanywhere,fontsize=\small,linenos,numbersep=9pt,autogobble,tabsize=4,style=clionlight}
% Enrich syntax colors for specific languages while keeping light theme
\setminted[c++]{style=clionlight}
\setminted[c]{style=clionlight}
\setminted[nasm]{style=clionlight}
\setminted[cmake]{style=clionlight}

% tcolorbox skins
\tcbset{enhanced, boxrule=0.3pt, arc=2pt, colback=white, colframe=CodeAccent!20, left=6pt,right=6pt,top=4pt,bottom=4pt}

% Admonitions
% Unify all tip-like boxes to light purple theme
\newtcolorbox{notebox}[1][]{colback=QSBack,colframe=QSFrame,coltitle=black,
  left=8pt,right=6pt,top=4pt,bottom=4pt,boxrule=0.4pt,arc=2pt,breakable,
  borderline west={2pt}{0pt}{QSAccent},title=\bfseries 注意,#1}
\newtcolorbox{warnbox}[1][]{colback=QSBack,colframe=QSFrame,coltitle=black,
  left=8pt,right=6pt,top=4pt,bottom=4pt,boxrule=0.4pt,arc=2pt,breakable,
  borderline west={2pt}{0pt}{QSAccent},title=\bfseries 警告,#1}
\newtcolorbox{tipbox}[1][]{colback=QSBack,colframe=QSFrame,coltitle=black,
  left=8pt,right=6pt,top=4pt,bottom=4pt,boxrule=0.4pt,arc=2pt,breakable,
  borderline west={2pt}{0pt}{QSAccent},title=\bfseries 提示,#1}
% Quick-start box: alias to purple tipbox
\newtcolorbox{qsbox}[1][]{colback=QSBack,colframe=QSFrame,coltitle=black,
  left=8pt,right=6pt,top=4pt,bottom=4pt,boxrule=0.4pt,arc=2pt,breakable,
  borderline west={2pt}{0pt}{QSAccent},title=\bfseries 提示,#1}

% Code gutter layout
\newlength{\CodeGutterWidth}
\setlength{\CodeGutterWidth}{2.4em}

% Unified code environment using tcolorbox + minted listing engine with gutter
% Usage: \begin{codeblock}[Title]{c++} ... \end{codeblock}
\newtcblisting{codeblock}[2][]{listing engine=minted,
  minted language=#2,
  minted options={linenos,breaklines,autogobble,tabsize=4,numbersep=9pt},
  colback=CodeBg,colframe=CodeAccent!20,breakable,title=#1,coltitle=black,
  colbacktitle=CodeTitleBack,fonttitle=\bfseries,enhanced,
  left=6pt,right=6pt,top=4pt,bottom=4pt,boxrule=0.3pt,arc=2pt,listing only}

% Inline/include code files
% \codefile[options]{lang}{path}
% Safer implementation: avoid macro expansion inside tcolorbox keyvals.
% Render the blue header line inside the box content instead of title.
% Header format: "filename(first--last) — relative/path/to/file"
\newcommand{\codefile}[3][]{%
  \begingroup
  % Capture inputs
  \def\cfopts{#1}% minted options input (we parse first/last; don't rely on passing macro as-is)
  \def\cflang{#2}% language
  \def\cfpath{#3}% relative path shown in header

  % Extract (first--last) range from options, if provided
  \def\cfrange{}\def\cftmp{}\def\cffirst{}\def\cflast{}%
  % Extract firstline
  \IfSubStr{\cfopts}{firstline=}{%
    \StrBehind{\cfopts}{firstline=}[\cftmp]% get tail after key
    \IfSubStr{\cftmp}{,}{\StrBefore{\cftmp}{,}[\cffirst]}{\edef\cffirst{\cftmp}}%
  }{}%
  % Extract lastline (robust even if it's the final key without trailing comma)
  \IfSubStr{\cfopts}{lastline=}{%
    \StrBehind{\cfopts}{lastline=}[\cftmp]%
    \IfSubStr{\cftmp}{,}{\StrBefore{\cftmp}{,}[\cflast]}{\edef\cflast{\cftmp}}%
  }{}%
  \ifx\cffirst\empty\else
    \ifx\cflast\empty \edef\cfrange{(\cffirst)}\else \edef\cfrange{(\cffirst--\cflast)}\fi
  \fi

  % Build a safe title string for tcolorbox (monospace via fonttitle)
  \def\cfrangesfx{}%
  \ifx\cffirst\empty\else
    \ifx\cflast\empty \edef\cfrangesfx{ (\cffirst)}\else \edef\cfrangesfx{ (\cffirst--\cflast)}\fi
  \fi
  % Sanitize path for display: strip leading ../ or ./ segments
  \def\cfdisplaypath{#3}% raw path
  \IfBeginWith{\cfdisplaypath}{../}{\StrBehind{\cfdisplaypath}{../}[\cfdisplaypath]}{}%
  \IfBeginWith{\cfdisplaypath}{../}{\StrBehind{\cfdisplaypath}{../}[\cfdisplaypath]}{}%
  \IfBeginWith{\cfdisplaypath}{./}{\StrBehind{\cfdisplaypath}{./}[\cfdisplaypath]}{}%
  % Final title text: detokenized for safety
  \edef\cftitle{\expandafter\detokenize\expandafter{\cfdisplaypath}\cfrangesfx}%

  % The visual container; render a wrapping header inside to avoid overflow
  \begin{tcolorbox}[colback=CodeBg,colframe=CodeAccent!20,breakable,enhanced,
    left=6pt,right=6pt,top=4pt,bottom=4pt,boxrule=0.3pt,arc=2pt]
    {\ttfamily\bfseries\colorbox{CodeTitleBack}{\parbox[t]{\dimexpr\linewidth-2pt\relax}{\strut\cftitle}}}\par\smallskip
    \ifx\cffirst\empty
      \inputminted[linenos,breaklines,autogobble,tabsize=4,numbersep=9pt]{#2}{#3}%
    \else
      \ifx\cflast\empty
        \inputminted[firstline=\cffirst,linenos,breaklines,autogobble,tabsize=4,numbersep=9pt]{#2}{#3}%
      \else
        \inputminted[firstline=\cffirst,lastline=\cflast,linenos,breaklines,autogobble,tabsize=4,numbersep=9pt]{#2}{#3}%
      \fi
    \fi
  \end{tcolorbox}%
  \endgroup
}

% Deterministic range variant to avoid option parsing issues
% Usage: \codefilerange{lang}{path}{first}{last}
\newcommand{\codefilerange}[4]{%
  \begingroup
  \def\cflang{#1}%
  \def\cfpath{#2}%
  \def\cffirst{#3}%
  \def\cflast{#4}%
  % Sanitize path for display
  \def\cfdisplaypath{#2}%
  \IfBeginWith{\cfdisplaypath}{../}{\StrBehind{\cfdisplaypath}{../}[\cfdisplaypath]}{}%
  \IfBeginWith{\cfdisplaypath}{../}{\StrBehind{\cfdisplaypath}{../}[\cfdisplaypath]}{}%
  \IfBeginWith{\cfdisplaypath}{./}{\StrBehind{\cfdisplaypath}{./}[\cfdisplaypath]}{}%
  \edef\cftitle{\expandafter\detokenize\expandafter{\cfdisplaypath} (\cffirst--\cflast)}%
  \begin{tcolorbox}[colback=CodeBg,colframe=CodeAccent!20,breakable,enhanced,
    left=6pt,right=6pt,top=4pt,bottom=4pt,boxrule=0.3pt,arc=2pt]
    {\ttfamily\bfseries\colorbox{CodeTitleBack}{\parbox[t]{\dimexpr\linewidth-2pt\relax}{\strut\cftitle}}}\par\smallskip
    \inputminted[firstline=\cffirst,lastline=\cflast,linenos,breaklines,autogobble,tabsize=4,numbersep=9pt]{#1}{#2}%
  \end{tcolorbox}%
  \endgroup
}

% Concatenate two non-contiguous ranges under a single header, without line numbers
% Usage: \codefilerangetwo{lang}{path}{firstA}{lastA}{firstB}{lastB}
\newcommand{\codefilerangetwo}[6]{%
  \begingroup
  \def\cflang{#1}%
  \def\cfpath{#2}%
  \def\cfAfirst{#3}%
  \def\cfAlast{#4}%
  \def\cfBfirst{#5}%
  \def\cfBlast{#6}%
  % Sanitize path for display
  \def\cfdisplaypath{#2}%
  \IfBeginWith{\cfdisplaypath}{../}{\StrBehind{\cfdisplaypath}{../}[\cfdisplaypath]}{}%
  \IfBeginWith{\cfdisplaypath}{../}{\StrBehind{\cfdisplaypath}{../}[\cfdisplaypath]}{}%
  \IfBeginWith{\cfdisplaypath}{./}{\StrBehind{\cfdisplaypath}{./}[\cfdisplaypath]}{}%
  \edef\cftitle{\expandafter\detokenize\expandafter{\cfdisplaypath} (\cfAfirst--\cfAlast, \cfBfirst--\cfBlast)}%
  % Container with a single blue header
  \begin{tcolorbox}[colback=CodeBg,colframe=CodeAccent!20,breakable,enhanced,
    left=6pt,right=6pt,top=4pt,bottom=4pt,boxrule=0.3pt,arc=2pt]
    {\ttfamily\bfseries\colorbox{CodeTitleBack}{\parbox[t]{\dimexpr\linewidth-2pt\relax}{\strut\cftitle}}}\par\smallskip
    % First slice with line numbers starting at actual file line
    \inputminted[firstline=\cfAfirst,lastline=\cfAlast,breaklines,tabsize=4,numbersep=9pt,linenos,firstnumber=\cfAfirst,autogobble=false,gobble=0]{#1}{#2}%
    \vspace{2pt}\noindent{\ttfamily ...}\vspace{2pt}\\
    % Second slice with line numbers starting at actual file line
    \inputminted[firstline=\cfBfirst,lastline=\cfBlast,breaklines,tabsize=4,numbersep=9pt,linenos,firstnumber=\cfBfirst,autogobble=false,gobble=0]{#1}{#2}%
  \end{tcolorbox}%
  \endgroup
}

% Inline code (safe underscores, etc.) used in tables and text
% Usage: \codeinline{thread_start(name, prio, func, arg)}
% Inline code: robust in moving args (titles/bookmarks); underscores render as '_'
\DeclareRobustCommand{\codeinline}[1]{\texorpdfstring{\texttt{\detokenize{#1}}}{#1}}
% Improve line number readability for minted (FancyVerb)
\makeatletter
% Draw a thin vertical separator immediately after the line number
\renewcommand{\theFancyVerbLine}{\textcolor{CodeLineNumber}{\footnotesize\arabic{FancyVerbLine}}\textcolor{GutterLine}{\hspace{0.5em}\vrule width 0.2pt}}
\makeatother
